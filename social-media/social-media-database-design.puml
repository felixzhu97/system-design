@startuml
!theme plain
title 社交媒体系统数据库设计

' 用户相关表
entity "users" {
    * user_id : BIGINT <<PK>>
    --
    * username : VARCHAR(50) <<UK>>
    * email : VARCHAR(100) <<UK>>
    * phone : VARCHAR(20) <<UK>>
    * password_hash : VARCHAR(255)
    * nickname : VARCHAR(100)
    * avatar_url : VARCHAR(500)
    * bio : TEXT
    * gender : ENUM('M','F','O')
    * birthday : DATE
    * location : VARCHAR(100)
    * is_verified : BOOLEAN
    * is_active : BOOLEAN
    * followers_count : INT
    * following_count : INT
    * posts_count : INT
    * created_at : TIMESTAMP
    * updated_at : TIMESTAMP
}

entity "user_profiles" {
    * profile_id : BIGINT <<PK>>
    * user_id : BIGINT <<FK>>
    --
    education : VARCHAR(200)
    occupation : VARCHAR(100)
    company : VARCHAR(100)
    website : VARCHAR(200)
    interests : JSON
    privacy_settings : JSON
    created_at : TIMESTAMP
    updated_at : TIMESTAMP
}

entity "user_sessions" {
    * session_id : VARCHAR(128) <<PK>>
    * user_id : BIGINT <<FK>>
    --
    * device_type : VARCHAR(50)
    * ip_address : VARCHAR(45)
    * user_agent : TEXT
    * expires_at : TIMESTAMP
    * created_at : TIMESTAMP
}

' 关注关系表
entity "user_follows" {
    * follow_id : BIGINT <<PK>>
    * follower_id : BIGINT <<FK>>
    * following_id : BIGINT <<FK>>
    --
    * status : ENUM('active','blocked')
    * created_at : TIMESTAMP
}

' 内容相关表
entity "posts" {
    * post_id : BIGINT <<PK>>
    * user_id : BIGINT <<FK>>
    --
    * content : TEXT
    * content_type : ENUM('text','image','video','link')
    * media_urls : JSON
    * tags : JSON
    * location : VARCHAR(100)
    * privacy : ENUM('public','friends','private')
    * is_deleted : BOOLEAN
    * likes_count : INT
    * comments_count : INT
    * shares_count : INT
    * views_count : INT
    * created_at : TIMESTAMP
    * updated_at : TIMESTAMP
}

entity "comments" {
    * comment_id : BIGINT <<PK>>
    * post_id : BIGINT <<FK>>
    * user_id : BIGINT <<FK>>
    * parent_comment_id : BIGINT <<FK>>
    --
    * content : TEXT
    * media_url : VARCHAR(500)
    * is_deleted : BOOLEAN
    * likes_count : INT
    * replies_count : INT
    * created_at : TIMESTAMP
    * updated_at : TIMESTAMP
}

entity "likes" {
    * like_id : BIGINT <<PK>>
    * user_id : BIGINT <<FK>>
    * target_id : BIGINT
    * target_type : ENUM('post','comment')
    --
    * created_at : TIMESTAMP
}

entity "shares" {
    * share_id : BIGINT <<PK>>
    * user_id : BIGINT <<FK>>
    * post_id : BIGINT <<FK>>
    --
    * share_type : ENUM('repost','quote')
    * comment : TEXT
    * created_at : TIMESTAMP
}

' 消息相关表
entity "conversations" {
    * conversation_id : BIGINT <<PK>>
    --
    * conversation_type : ENUM('private','group')
    * title : VARCHAR(200)
    * created_by : BIGINT <<FK>>
    * created_at : TIMESTAMP
    * updated_at : TIMESTAMP
}

entity "conversation_participants" {
    * participant_id : BIGINT <<PK>>
    * conversation_id : BIGINT <<FK>>
    * user_id : BIGINT <<FK>>
    --
    * role : ENUM('admin','member')
    * joined_at : TIMESTAMP
    * left_at : TIMESTAMP
}

entity "messages" {
    * message_id : BIGINT <<PK>>
    * conversation_id : BIGINT <<FK>>
    * sender_id : BIGINT <<FK>>
    --
    * content : TEXT
    * message_type : ENUM('text','image','video','file')
    * media_url : VARCHAR(500)
    * is_deleted : BOOLEAN
    * created_at : TIMESTAMP
}

entity "message_reads" {
    * read_id : BIGINT <<PK>>
    * message_id : BIGINT <<FK>>
    * user_id : BIGINT <<FK>>
    --
    * read_at : TIMESTAMP
}

' 通知相关表
entity "notifications" {
    * notification_id : BIGINT <<PK>>
    * user_id : BIGINT <<FK>>
    * actor_id : BIGINT <<FK>>
    --
    * type : ENUM('like','comment','follow','mention','message')
    * target_id : BIGINT
    * target_type : ENUM('post','comment','user')
    * content : TEXT
    * is_read : BOOLEAN
    * created_at : TIMESTAMP
}

' 媒体文件表
entity "media_files" {
    * file_id : BIGINT <<PK>>
    * user_id : BIGINT <<FK>>
    --
    * original_name : VARCHAR(255)
    * file_path : VARCHAR(500)
    * file_size : BIGINT
    * mime_type : VARCHAR(100)
    * width : INT
    * height : INT
    * duration : INT
    * status : ENUM('uploading','processing','ready','failed')
    * created_at : TIMESTAMP
}

' 标签相关表
entity "hashtags" {
    * tag_id : BIGINT <<PK>>
    --
    * tag_name : VARCHAR(100) <<UK>>
    * usage_count : INT
    * created_at : TIMESTAMP
}

entity "post_hashtags" {
    * post_id : BIGINT <<FK,PK>>
    * tag_id : BIGINT <<FK,PK>>
    --
    * created_at : TIMESTAMP
}

' 举报和审核表
entity "reports" {
    * report_id : BIGINT <<PK>>
    * reporter_id : BIGINT <<FK>>
    * target_id : BIGINT
    * target_type : ENUM('post','comment','user')
    --
    * reason : ENUM('spam','abuse','inappropriate','copyright')
    * description : TEXT
    * status : ENUM('pending','resolved','dismissed')
    * created_at : TIMESTAMP
    * resolved_at : TIMESTAMP
}

' 用户黑名单表
entity "user_blocks" {
    * block_id : BIGINT <<PK>>
    * blocker_id : BIGINT <<FK>>
    * blocked_id : BIGINT <<FK>>
    --
    * created_at : TIMESTAMP
}

' 关系定义
users ||--o{ user_profiles : "has"
users ||--o{ user_sessions : "has"
users ||--o{ posts : "creates"
users ||--o{ comments : "writes"
users ||--o{ likes : "gives"
users ||--o{ shares : "makes"
users ||--o{ notifications : "receives"
users ||--o{ media_files : "uploads"
users ||--o{ reports : "reports"

users ||--o{ user_follows : "follower"
users ||--o{ user_follows : "following"
users ||--o{ user_blocks : "blocker"
users ||--o{ user_blocks : "blocked"

posts ||--o{ comments : "has"
posts ||--o{ likes : "receives"
posts ||--o{ shares : "shared"
posts ||--o{ post_hashtags : "tagged"

comments ||--o{ comments : "parent"
comments ||--o{ likes : "receives"

hashtags ||--o{ post_hashtags : "used_in"

conversations ||--o{ conversation_participants : "has"
conversations ||--o{ messages : "contains"
users ||--o{ conversation_participants : "participates"
users ||--o{ messages : "sends"
messages ||--o{ message_reads : "read_by"
users ||--o{ message_reads : "reads"

note as N1
    索引策略：
    1. users: username, email, phone (唯一索引)
    2. posts: user_id, created_at (复合索引)
    3. user_follows: follower_id, following_id (复合索引)
    4. likes: user_id + target_id + target_type (复合唯一索引)
    5. comments: post_id, created_at (复合索引)
    6. notifications: user_id, is_read, created_at (复合索引)
    7. messages: conversation_id, created_at (复合索引)
end note

note as N2
    分表策略：
    1. posts 按时间分表 (按月)
    2. likes 按用户ID哈希分表
    3. comments 按post_id哈希分表
    4. messages 按conversation_id哈希分表
    5. notifications 按user_id哈希分表
end note

note as N3
    缓存策略：
    1. 用户基本信息 (Redis Hash)
    2. 热门帖子列表 (Redis List)
    3. 用户关注关系 (Redis Set)
    4. 实时计数器 (Redis String)
    5. 用户会话信息 (Redis String)
end note

@enduml 